<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maritime Route Simulator - API Only</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a1929;
            color: #fff;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend h3 {
            margin-bottom: 10px;
            color: #60a5fa;
            font-size: 14px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 12px;
        }

        .legend-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
        }

        /* Port Marker Base Styles */
        .port-marker {
            width: 14px;
            height: 14px;
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
        }

        /* Hub Ports (Orange Circle) */
        .port-buyer {
            background: #ff8c00;
            border-radius: 50%;
        }

        /* Seller Ports (Yellow Triangle) */
        .port-seller {
            background: #ffd700;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            width: 16px;
            height: 16px;
        }

        /* Parity Ports (Green Circle) */
        .port-other {
            background: #3cb371;
            border-radius: 50%;
        }

        /* Ship Marker (Emoji) */
        .ship-marker {
            font-size: 24px;
            line-height: 1;
            cursor: default;
        }

        .mapboxgl-popup-content {
            background: rgba(15, 23, 42, 0.95);
            color: #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        .mapboxgl-popup-close-button {
            color: #e2e8f0;
        }

        .notification {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="legend">
        <h3>Legend</h3>
        <div class="legend-item">
            <div class="legend-icon" style="background: #ff8c00; border-radius: 50%;"></div>
            <span>Hub</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #ffd700; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
            <span>Seller</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #3cb371; border-radius: 50%;"></div>
            <span>Parity</span>
        </div>
        <div class="legend-item">
            <span style="font-size: 20px; margin-right: 8px;">ðŸš¢</span>
            <span>Active Ship</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #3b82f6; border-radius: 2px;"></div>
            <span>Active Route</span>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Mapbox configuration
        mapboxgl.accessToken = 'pk.eyJ1IjoiamRjbTEwMjAwMSIsImEiOiJjbWhtcTdhNGQyNHlmMnFwcjF3YTF6YmlyIn0.uugX8H3ObKHWL7ia1MBFBg';

        // Maritime routes data
        const maritimeData = {
  "generated": "2025-11-06T15:04:04.524Z",
  "routes": {
    "antofagasta_to_neworleans": {
      "from": "antofagasta",
      "to": "neworleans",
      "coordinates": [
        [-70.38027368857385, -23.65804538743801],
        [-70.77074246668165, -23.521415977460208],
        [-83.18053964972563, -4.5682158023983135],
        [-79.47925248454354, 8.678946260002746],
        [-79.56296322591182, 8.94234018619133],
        [-79.69775941454282, 9.114453220642758],
        [-90.06939693248827, 29.879680792858323]
      ]
    },
    "antofagasta_to_houston": {
      "from": "antofagasta",
      "to": "houston",
      "coordinates": [
        [-70.37351565564786, -23.685370364904358],
        [-70.92459677478783, -23.4237673862346],
        [-83.57706656986689, -2.6829113001891045],
        [-79.46696295773795, 8.889314384648316],
        [-80.04214809295547, 9.346375749102577],
        [-86.68957234790524, 22.351157464502663],
        [-94.71820512763713, 29.348665755917267],
        [-94.81304354354992, 29.36316756881537],
        [-95.05929065854988, 29.758267302284438]
      ]
    },
    "antofagasta_to_shanghai": {
      "from": "antofagasta",
      "to": "shanghai",
      "coordinates": [
        [-70.38129892695875, -23.681594317000716],
        [-154.0587559353398, 7.918334989102462],
        [-180.29663552068294, 16.17512824531893],
        [-188.10864255780172, 19.300622889693074],
        [-209.0057770269071, 27.598176555485708],
        [-229.20634034704233, 28.825782998206478],
        [-239.73089925720592, 31.27749328048739]
      ]
    },
    "antofagasta_to_ningbo": {
      "from": "antofagasta",
      "to": "ningbo",
      "coordinates": [
        [-70.39409129978985, -23.64973039600912],
        [-226.48390448404803, 28.52560965993932],
        [-238.5011106986996, 29.580344046708504]
      ]
    },
    "antofagasta_to_busan": {
      "from": "antofagasta",
      "to": "busan",
      "coordinates": [
        [-70.38331695493582, -23.644582393252364],
        [-76.98143466744324, -21.878499367531518],
        [-229.23496975989426, 26.84726733089785],
        [-231.8503544487504, 34.679335811394026]
      ]
    },
    "antofagasta_to_rotterdam": {
      "from": "antofagasta",
      "to": "rotterdam",
      "coordinates": [
        [-70.33552904992261, -23.681802951412237],
        [-74.48304093543494, -22.85756101323257],
        [-84.4922729143056, -2.4822260034416956],
        [-79.21429382133846, 8.648339728697124],
        [-80.33303628129893, 9.70620964779836],
        [-60.26840516428908, 19.816379341638665],
        [-2.552198539061095, 49.85040139723],
        [1.4597996747856428, 50.94129949061167],
        [3.9514568196404127, 52.01378386432762],
        [4.2920884293174595, 51.91661875344468]
      ]
    },
    "antofagasta_to_antwerp": {
      "from": "antofagasta",
      "to": "antwerp",
      "coordinates": [
        [-70.36602463236794, -23.704776098187637],
        [-73.61500404095676, -23.24656550130294],
        [-84.63420402488448, -3.7758279974820113],
        [-79.26239674091981, 8.735171821003334],
        [-80.40019168578668, 9.630566191675726],
        [-60.67511725889308, 18.909058035896166],
        [-2.8655899410126153, 49.8905755679736],
        [3.2723984850456986, 51.45597152918657],
        [3.6318428496692547, 51.41073561830481],
        [3.8144026633632677, 51.36359329180718],
        [3.9805950454853303, 51.41623239305133],
        [4.202184888313923, 51.38167025737357]
      ]
    },
    "antofagasta_to_valencia": {
      "from": "antofagasta",
      "to": "valencia",
      "coordinates": [
        [-70.35199717421811, -23.64221606880845],
        [-71.26899149690549, -23.523370291426062],
        [-85.1426389785789, -3.129083969896328],
        [-79.19192788268246, 7.955686792082034],
        [-79.48586964943436, 8.88961155506189],
        [-80.24747217960793, 9.570715194241231],
        [-61.246157374576185, 19.303474479423286],
        [-15.284130933572754, 34.832702596046445],
        [-4.256919701688531, 36.09184521888439],
        [-0.5188301185889088, 37.035696420366264],
        [0.8491739890918666, 38.84339995551264],
        [0.12203667059463896, 39.48362106984945],
        [-0.3181317020702181, 39.42841042230626]
      ]
    },
    "antofagasta_to_singapore": {
      "from": "antofagasta",
      "to": "singapore",
      "coordinates": [
        [-70.34493369904119, -23.69215197330182],
        [-205.15502306494105, -13.231405691018125],
        [-225.15206365906704, -8.321926680462354],
        [-247.64873432745873, -5.219569889748101],
        [-253.900512616017, 0.16901384178579804]
      ]
    },
    "antofagasta_to_newark": {
      "from": "antofagasta",
      "to": "newark",
      "coordinates": [
        [-70.40678028832394, -23.728462727587626],
        [-72.31000814689757, -22.89387540365773],
        [-85.17522141902634, -4.2772522110122395],
        [-79.29251780366793, 8.759704105808495],
        [-80.4563197467571, 9.706442907106066],
        [-73.50901703739343, 20.358404571464902],
        [-72.57123351902327, 21.479623679049993],
        [-72.09723304693972, 22.918938495110936],
        [-73.7512529627448, 40.42985227155464],
        [-74.05522080227816, 40.60378404420146]
      ]
    },
    "antofagasta_to_montreal": {
      "from": "antofagasta",
      "to": "montreal",
      "coordinates": [
        [-70.37681944168037, -23.68056949566143],
        [-71.64320194750157, -23.16125104527829],
        [-82.9906801716787, -4.35803920060134],
        [-82.58740311202791, -0.5860975282232346],
        [-79.66399635798997, 8.991838695009334],
        [-80.1781263238636, 9.473168853976883],
        [-60.07024936629765, 21.012950867042854],
        [-59.59611940042403, 21.46093898896296],
        [-62.56887486066945, 32.55824866978039],
        [-65.53848035470992, 43.5904945662693],
        [-68.55598188532831, 46.8566828625579],
        [-72.72490279408154, 46.25129637442046],
        [-73.61923345139037, 45.46301336964149]
      ]
    },
    "callao_to_rotterdam": {
      "from": "callao",
      "to": "rotterdam",
      "coordinates": [
        [-77.13740288052355, -12.042174522320934],
        [-82.98697248551603, -4.384527703899025],
        [-79.38165092688719, 8.842014953951377],
        [-80.2066813461081, 9.482932355526444],
        [-46.29473700256813, 27.173026182615686],
        [-2.158867745600361, 50.10418483816554],
        [1.3274839459096484, 50.85637317946478],
        [3.3597428532351614, 52.07479211103336],
        [4.111899731178795, 51.97698362413186],
        [4.301087323071016, 51.89006916866472],
        [4.458743649646664, 51.904948051462696]
      ]
    },
    "callao_to_hamburg": {
      "from": "callao",
      "to": "hamburg",
      "coordinates": [
        [-77.14779610597394, -12.051149177644817],
        [-83.6464354887381, -6.226526924440407],
        [-78.71239601249097, 7.8400929657871785],
        [-79.61964961110102, 9.000742157147329],
        [-80.24033293969444, 9.528831930428339],
        [-35.76877279893401, 31.809244874833283],
        [-4.635791951109297, 49.598868009511165],
        [1.2752695008925627, 50.744548045510356],
        [4.881344459967977, 53.5664979430546],
        [8.478076049984054, 53.93780540235275],
        [8.931595450426954, 53.86145847705046],
        [9.38511485087102, 53.86909944817867],
        [9.734972674069695, 53.546975622825386],
        [10.007084314336367, 53.531574839744735]
      ]
    },
    "callao_to_antwerp": {
      "from": "callao",
      "to": "antwerp",
      "coordinates": [
        [-77.12833635775144, -12.058538771363843],
        [-82.61754036712634, -6.003844453311942],
        [-79.13603399981073, 7.99063413292204],
        [-79.39215312056194, 8.899047328502434],
        [-80.54658260572036, 9.685965983828723],
        [-61.8490624403524, 18.567569551340924],
        [-2.3071673448225454, 50.038405339052275],
        [1.039271134593946, 50.537299238129805],
        [2.046250656531214, 51.324053685664666],
        [3.4691298832154587, 51.431456233156695],
        [3.802398921816973, 51.37276717305676],
        [3.9371484516905184, 51.38821472420332],
        [3.9591483749351255, 51.42252395194001],
        [4.110397847242382, 51.38478238560745],
        [4.242397386710394, 51.35903163943303],
        [4.2863972331998355, 51.302329008220596],
        [4.35239700293377, 51.221449627739986]
      ]
    },
    "callao_to_valencia": {
      "from": "callao",
      "to": "valencia",
      "coordinates": [
        [-77.07450961035555, -12.019156658689084],
        [-82.2318522568493, -5.766636389022338],
        [-80.75503055055405, 3.12586100838152],
        [-79.37187363171145, 8.77265812725689],
        [-80.01231094128018, 9.378812615817694],
        [-37.78693710643847, 28.271327861440213],
        [-6.082934235110287, 35.940269193780935],
        [-4.2781408832818215, 36.07867789910446],
        [-0.6385038686482858, 36.99774471673568],
        [0.565675633794342, 38.98921039743928],
        [-0.1018769811103084, 39.44464493282544],
        [-0.3609272495797029, 39.37536289863286]
      ]
    },
    "callao_to_shanghai": {
      "from": "callao",
      "to": "shanghai",
      "coordinates": [
        [-77.13932668182368, -12.047655392948982],
        [-229.97753923429357, 28.93250464686099],
        [-239.0432828701107, 30.98366791566052]
      ]
    },
    "callao_to_ningbo": {
      "from": "callao",
      "to": "ningbo",
      "coordinates": [
        [-77.03788642066122, -12.007745492290852],
        [-229.50963798573264, 27.618958891852714],
        [-239.0067254115147, 28.362733239647724]
      ]
    },
    "callao_to_busan": {
      "from": "callao",
      "to": "busan",
      "coordinates": [
        [-77.02667178662523, -12.00188207405023],
        [-229.95340163944522, 29.219063834641204],
        [-232.3884167477807, 34.78079796679873]
      ]
    },
    "callao_to_singapore": {
      "from": "callao",
      "to": "singapore",
      "coordinates": [
        [-77.08733388246937, -12.067443396290031],
        [-213.94269010696684, -11.796428868964568],
        [-219.0496489885117, -10.254109924068203],
        [-233.38841815592627, -6.562884575235316],
        [-250.47708825955723, -4.412279024067516],
        [-255.72304014090264, 2.2107389635468735]
      ]
    },
    "antofagasta_to_hamburg": {
      "from": "antofagasta",
      "to": "hamburg",
      "coordinates": [
        [-70.3948002838144, -23.686578802388183],
        [-71.02439833929935, -23.51349688547316],
        [-84.36315536586682, -3.8974978539955885],
        [-79.31885868815691, 8.713315875068503],
        [-79.67609939923123, 9.081827998505489],
        [-80.11739674820541, 9.40331827365327],
        [-39.4566338219787, 27.76327430163498],
        [-2.995324656181367, 49.86810360564428],
        [1.2363690139382015, 50.72379343069662],
        [4.720560696836429, 53.415463124936906],
        [8.438875854275182, 54.03851819287817],
        [8.882133774087606, 53.863038660512785],
        [9.260917814653197, 53.863038660512785],
        [9.5832872108802, 53.619949644330916],
        [9.749600830993387, 53.54222055265504]
      ]
    }
  }
};

        // Port locations (derived from routes)
        const portLocations = {
            antofagasta: { name: 'Antofagasta', coords: [-70.38, -23.65] },
            callao: { name: 'Callao', coords: [-77.13, -12.04] },
            neworleans: { name: 'New Orleans', coords: [-90.07, 29.88] },
            houston: { name: 'Houston', coords: [-95.06, 29.76] },
            shanghai: { name: 'Shanghai', coords: [121.47, 31.23] },
            ningbo: { name: 'Ningbo', coords: [121.55, 29.87] },
            busan: { name: 'Busan', coords: [129.04, 35.10] },
            rotterdam: { name: 'Rotterdam', coords: [4.48, 51.92] },
            antwerp: { name: 'Antwerp', coords: [4.40, 51.22] },
            valencia: { name: 'Valencia', coords: [-0.38, 39.47] },
            singapore: { name: 'Singapore', coords: [103.85, 1.29] },
            newark: { name: 'Newark', coords: [-74.17, 40.73] },
            montreal: { name: 'Montreal', coords: [-73.56, 45.50] },
            hamburg: { name: 'Hamburg', coords: [9.99, 53.55] }
        };

        // Global variables
        let map;
        let shipMarker = null;
        let currentAnimation = null;
        let currentRouteLayerId = null;

        // Initialize map
        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [-50, 20],
                zoom: 2,
                projection: 'mercator'
            });

            map.on('load', () => {
                // Only add port markers on initialization
                addPortMarkers();
                
                console.log('%câš“ Maritime Simulator Loaded', 'color: #60a5fa; font-size: 16px; font-weight: bold;');
                console.log('%cUse: startShipmentAnimation(shipmentData)', 'color: #22c55e; font-size: 14px;');
                console.log('%cExample:', 'color: #94a3b8; font-size: 12px;');
                console.log(`
const shipmentData = {
    shipmentId: 'SHIP-001',
    routeCoords: maritimeData.routes.antofagasta_to_shanghai.coordinates,
    fromPort: 'Antofagasta',
    toPort: 'Shanghai'
};

startShipmentAnimation(shipmentData).then(result => {
    console.log('Shipment arrived:', result);
});
                `);
                console.log('%cAvailable routes:', 'color: #94a3b8; font-size: 12px;', Object.keys(maritimeData.routes));
            });
        }

        // Add port markers to map
        function addPortMarkers() {
            // Define port categories
            // Hub ports (Orange Circle): Major distribution centers
            const hubPorts = ['shanghai', 'neworleans', 'rotterdam'];
            // Seller ports (Yellow Triangle): Origin/supplier ports
            const sellerPorts = ['antofagasta', 'callao'];
            // Parity ports (Green Circle): All other ports
            
            Object.entries(portLocations).forEach(([portId, port]) => {
                const el = document.createElement('div');
                el.className = 'port-marker';
                
                // Apply category-specific styling
                if (hubPorts.includes(portId)) {
                    el.classList.add('port-buyer');  // Orange circle - Hub
                } else if (sellerPorts.includes(portId)) {
                    el.classList.add('port-seller');  // Yellow triangle - Seller
                } else {
                    el.classList.add('port-other');  // Green circle - Parity
                }
                
                const marker = new mapboxgl.Marker(el)
                    .setLngLat(port.coords)
                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`<strong>${port.name}</strong><br>Port Code: ${portId.toUpperCase()}`))
                    .addTo(map);
            });
        }

        // Draw route on map (temporary, only during animation)
        function drawRoute(routeCoords, routeId) {
            // Remove existing route if present
            removeRoute();

            currentRouteLayerId = `animated-route-${routeId}`;

            // Add source for this specific route
            map.addSource(currentRouteLayerId, {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: routeCoords
                    }
                }
            });

            // Add layer to display the route
            map.addLayer({
                id: currentRouteLayerId,
                type: 'line',
                source: currentRouteLayerId,
                paint: {
                    'line-color': '#3b82f6',
                    'line-width': 3,
                    'line-opacity': 0.8
                }
            });
        }

        // Remove route from map
        function removeRoute() {
            if (currentRouteLayerId && map.getLayer(currentRouteLayerId)) {
                map.removeLayer(currentRouteLayerId);
                map.removeSource(currentRouteLayerId);
                currentRouteLayerId = null;
            }
        }

        // Core animation function
        function animateShip(shipmentId, routeCoords, onComplete) {
            const duration = 8000; // 8 seconds for animation
            const startTime = Date.now();
            
            // Create ship marker if it doesn't exist
            if (!shipMarker) {
                const el = document.createElement('div');
                el.className = 'ship-marker';
                el.textContent = 'ðŸš¢';
                shipMarker = new mapboxgl.Marker(el).setLngLat(routeCoords[0]).addTo(map);
            } else {
                shipMarker.setLngLat(routeCoords[0]);
            }

            function animate() {
                const now = Date.now();
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = progress; // Linear easing

                // Calculate position along route
                const totalSegments = routeCoords.length - 1;
                const position = easedProgress * totalSegments;
                const currentSegment = Math.floor(position);
                const segmentProgress = position - currentSegment;

                if (currentSegment < totalSegments) {
                    const start = routeCoords[currentSegment];
                    const end = routeCoords[currentSegment + 1];
                    
                    const lng = start[0] + (end[0] - start[0]) * segmentProgress;
                    const lat = start[1] + (end[1] - start[1]) * segmentProgress;
                    
                    shipMarker.setLngLat([lng, lat]);
                }

                if (progress < 1) {
                    currentAnimation = requestAnimationFrame(animate);
                } else {
                    // Animation complete
                    showNotification(`Shipment ${shipmentId} has arrived!`);
                    
                    // Remove the route line
                    removeRoute();
                    
                    // Remove ship marker
                    if (shipMarker) {
                        shipMarker.remove();
                        shipMarker = null;
                    }
                    
                    // Call completion callback
                    if (onComplete) {
                        const arrivalData = {
                            shipmentId: shipmentId,
                            status: 'Arrived',
                            actualArrivalAt: new Date().toISOString(),
                            finalPosition: routeCoords[routeCoords.length - 1]
                        };
                        onComplete(arrivalData);
                    }
                }
            }

            animate();
        }

        // PUBLIC API: Start shipment animation
        // This is the main function that external modules should call
        function startShipmentAnimation(shipmentData) {
            return new Promise((resolve) => {
                // Validate input
                if (!shipmentData || !shipmentData.shipmentId || !shipmentData.routeCoords) {
                    console.error('Invalid shipment data provided');
                    console.error('Required fields: shipmentId, routeCoords');
                    resolve(null);
                    return;
                }

                const { shipmentId, routeCoords, fromPort, toPort } = shipmentData;

                console.log(`ðŸš¢ Starting shipment ${shipmentId}: ${fromPort || '?'} â†’ ${toPort || '?'}`);

                // Draw the route on the map
                drawRoute(routeCoords, shipmentId);

                // Center map on route with animation
                const bounds = new mapboxgl.LngLatBounds();
                routeCoords.forEach(coord => bounds.extend(coord));
                map.fitBounds(bounds, { padding: 100, duration: 1000 });

                // Small delay to let map animation settle
                setTimeout(() => {
                    // Start the ship animation
                    animateShip(shipmentId, routeCoords, (arrivalData) => {
                        console.log(`âœ… Shipment ${shipmentId} arrived!`, arrivalData);
                        // Resolve promise when animation completes
                        resolve(arrivalData);
                    });
                }, 1000);
            });
        }

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // Initialize the application
        initMap();

        // Make maritimeData and startShipmentAnimation globally accessible
        window.maritimeData = maritimeData;
        window.startShipmentAnimation = startShipmentAnimation;
        window.portLocations = portLocations;
    </script>
</body>
</html>